package main

import (
	tools "daily-cve-trends-checker/tools"
	"strconv"

	"github.com/projectdiscovery/gologger"
)

var (
	red    string = "#FF0000"
	orange string = "#FFB300"
	yellow string = "#FFFF00"
	blue   string = "#0080FF"
	black  string = "#000000"
)

const (
	webhookUrl string = "슬랙 웹훅 URL을 넣으시오!"
)

func main() {
	cveInfos, err := tools.Getcve("day")
	if err != nil {
		gologger.Warning().Msgf(err.Error())
	}

	var attachments = []tools.Attachment{}
	var cveRank int = 1
	for _, cve := range cveInfos {
		attachment := tools.Attachment{}
		if 9 < cve.CVSSv3Score {
			attachment.Color = &red
		} else if 8 < cve.CVSSv3Score {
			attachment.Color = &orange
		} else if 7 < cve.CVSSv3Score {
			attachment.Color = &yellow
		} else if 6 < cve.CVSSv3Score {
			attachment.Color = &orange
		} else if 5 < cve.CVSSv3Score {
			attachment.Color = &blue
		} else {
			attachment.Color = &black
		}

		var cvssv3Score string
		var cvssv3Severity string
		if cve.CVSSv3Score == 0 {
			cvssv3Score = "N/A"
			cvssv3Severity = "N/A"
		} else {
			cvssv3Score = strconv.FormatFloat(cve.CVSSv3Score, 'f', 1, 64)
			cvssv3Severity = cve.CVSSv3Severity
		}

		attachment.AddField(
			tools.Field{
				Title: "`" + strconv.Itoa(cveRank) + ". " + cve.CVENumer + "`",
				Value: "\n```CVSSv3Score : " + cvssv3Score + "(" + cvssv3Severity + ")```\n```Description : " + cve.Description + "```",
				Short: false,
			},
		)
		attachment.AddAction(
			tools.Action{
				Type:  "button",
				Text:  "MITRE CVE 👏",
				Url:   "https://cve.mitre.org/cgi-bin/cvename.cgi?name=" + cve.CVENumer,
				Style: "primary",
			},
		)
		attachment.AddAction(
			tools.Action{
				Type:  "button",
				Text:  "Best PoC github repo 🛫",
				Url:   cve.GithubRepo.Url,
				Style: "primary",
			},
		)
		attachments = append(attachments, attachment)
		cveRank++
	}

	// time := strconv.Itoa(time.Now().Year()) + " " + time.Now().Month().String() + " " + strconv.Itoa(time.Now().Day())
	payload := tools.Payload{
		Username: "CVE Trends Checker",
		IconUrl:  "https://www.twcert.org.tw/Public/Images/201904/8971904082033929a6.jpg",
		// Text:        "`" + time + " CVE trends top 10`",
		Attachments: attachments,
	}
	payload.SendSlack(webhookUrl)
}
